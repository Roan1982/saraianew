{% extends 'core/base.html' %}
{% load static %}

{% block title %}Actividad de Usuarios - SARA{% endblock %}
{% block page_title %}Monitoreo de Actividad{% endblock %}
{% block breadcrumb %}Actividad{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-eye"></i> Monitoreo de Actividad
                    </h3>
                    <div class="card-tools">
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Volver al Dashboard
                        </a>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card-body">
                    <form method="get" class="mb-4">
                        <div class="row">
                            {% if usuarios %}
                            <div class="col-md-3">
                                <label for="usuario">Usuario:</label>
                                <select name="usuario" id="usuario" class="form-control">
                                    <option value="">Todos los usuarios</option>
                                    {% for usuario in usuarios %}
                                    <option value="{{ usuario.id }}" {% if usuario_filtro == usuario.id|stringformat:"s" %}selected{% endif %}>
                                        {{ usuario.get_full_name }} ({{ usuario.username }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="col-md-3">
                                <label for="fecha_desde">Desde:</label>
                                <input type="date" name="fecha_desde" id="fecha_desde" class="form-control"
                                       value="{{ fecha_desde }}">
                            </div>
                            <div class="col-md-3">
                                <label for="fecha_hasta">Hasta:</label>
                                <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control"
                                       value="{{ fecha_hasta }}">
                            </div>
                            <div class="col-md-3">
                                <label>&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                    <a href="{% url 'actividad_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Limpiar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Estadísticas rápidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="small-box bg-info">
                                <div class="inner">
                                    <h3>{{ page_obj.paginator.count }}</h3>
                                    <p>Total de Registros</p>
                                </div>
                                <div class="icon">
                                    <i class="fas fa-list"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="small-box bg-success">
                                <div class="inner">
                                    <h3>{{ page_obj|length }}</h3>
                                    <p>En esta página</p>
                                </div>
                                <div class="icon">
                                    <i class="fas fa-eye"></i>
                                </div>
                            </div>
                        </div>
                        {% if usuarios %}
                        <div class="col-md-3">
                            <div class="small-box bg-warning">
                                <div class="inner">
                                    <h3>{{ usuarios|length }}</h3>
                                    <p>Usuarios Activos</p>
                                </div>
                                <div class="icon">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Tabla de actividad -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Timestamp</th>
                                    <th>Ventana Activa</th>
                                    <th>Productividad</th>
                                    <th>Procesos</th>
                                    <th>Carga Sistema</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for actividad in page_obj %}
                                <tr>
                                    <td>
                                        {% if user.rol in 'admin,supervisor' %}
                                        <a href="{% url 'actividad_usuario_detail' actividad.usuario.id %}">
                                            {{ actividad.usuario.get_full_name }}
                                        </a>
                                        {% else %}
                                        {{ actividad.usuario.get_full_name }}
                                        {% endif %}
                                    </td>
                                    <td>{{ actividad.timestamp|date:"d/m/Y H:i:s" }}</td>
                                    <td>
                                        <span class="badge badge-info">
                                            {{ actividad.ventana_activa|truncatechars:30 }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if actividad.productividad == 'productive' %}
                                            <span class="badge badge-success">Productiva</span>
                                        {% elif actividad.productividad == 'unproductive' %}
                                            <span class="badge badge-danger">Improductiva</span>
                                        {% elif actividad.productividad == 'gaming' %}
                                            <span class="badge badge-warning">Juegos</span>
                                        {% else %}
                                            <span class="badge badge-secondary">Neutral</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ actividad.procesos_activos|length }} procesos</small>
                                    </td>
                                    <td>
                                        <small>
                                            CPU: {{ actividad.carga_sistema.cpu|default:"N/A" }}%<br>
                                            RAM: {{ actividad.carga_sistema.mem|default:"N/A" }}%
                                        </small>
                                    </td>
                                    <td>
                                        {% if user.rol in 'admin,supervisor' %}
                                        <a href="{% url 'actividad_usuario_detail' actividad.usuario.id %}"
                                           class="btn btn-sm btn-info">
                                            <i class="fas fa-user"></i> Ver Usuario
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <em>No hay registros de actividad</em>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    {% if page_obj.has_other_pages %}
                    <div class="d-flex justify-content-center">
                        <nav aria-label="Navegación de páginas">
                            <ul class="pagination">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if usuario_filtro %}&usuario={{ usuario_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">
                                        Anterior
                                    </a>
                                </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if usuario_filtro %}&usuario={{ usuario_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">
                                        {{ num }}
                                    </a>
                                </li>
                                {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if usuario_filtro %}&usuario={{ usuario_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">
                                        Siguiente
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}